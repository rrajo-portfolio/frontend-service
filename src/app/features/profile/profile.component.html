<ng-container *ngIf="user$ | async as currentUser; else loading">
  <div class="profile-container">
    <header class="profile-header">
      <div class="breadcrumb">
        <a routerLink="/catalog">{{ 'profile.breadcrumb.catalog' | translate }}</a>
        <lucide-icon name="ChevronRight" size="14"></lucide-icon>
        <span>{{ 'profile.breadcrumb.profile' | translate }}</span>
      </div>
      <h1 class="page-title">{{ 'profile.hero.title' | translate }}</h1>
      <p class="page-description">
        {{ 'profile.hero.description' | translate }}
      </p>
    </header>

    <div class="profile-content">
      <aside class="profile-sidebar">
        <section class="avatar-card">
          <div class="avatar-wrapper">
            <img
              *ngIf="currentUser.avatar; else initials"
              [src]="currentUser.avatar"
              [alt]="currentUser.name"
              class="avatar-lg"
            />
            <ng-template #initials>
              <div class="avatar-placeholder">
                {{ getUserInitials(currentUser) }}
              </div>
            </ng-template>
            <button
              class="avatar-edit"
              type="button"
              [attr.aria-label]="'profile.hero.changeAvatar' | translate"
              (click)="changeAvatar()"
            >
              <lucide-icon name="Camera" size="16"></lucide-icon>
            </button>
          </div>
          <h2 class="user-name">{{ currentUser.name }}</h2>
          <p class="user-email">{{ currentUser.email }}</p>
          <div class="user-status">
            <span class="status-badge active">
              <span class="status-dot"></span>
              {{ 'profile.status.active' | translate }}
            </span>
          </div>
          <div class="user-stats" *ngIf="userStats$ | async as stats">
            <div class="stat-item">
              <div class="stat-value">{{ stats?.orderCount ?? 0 }}</div>
              <div class="stat-label">{{ 'profile.stats.orders' | translate }}</div>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <div class="stat-value">
                {{ stats?.memberSince | date: 'yyyy' }}
              </div>
              <div class="stat-label">{{ 'profile.stats.memberSince' | translate }}</div>
            </div>
          </div>
        </section>

        <section class="quick-actions-card">
          <h3 class="card-title">{{ 'profile.quickActions.title' | translate }}</h3>
          <button class="action-button" type="button" (click)="changePassword()">
            <lucide-icon name="Lock" size="16"></lucide-icon>
            <span>{{ 'profile.quickActions.password' | translate }}</span>
            <lucide-icon class="arrow" name="ChevronRight" size="16"></lucide-icon>
          </button>
          <button class="action-button" type="button" (click)="downloadData()">
            <lucide-icon name="Download" size="16"></lucide-icon>
            <span>{{ 'profile.quickActions.download' | translate }}</span>
            <lucide-icon class="arrow" name="ChevronRight" size="16"></lucide-icon>
          </button>
          <button class="action-button" type="button" (click)="viewActivity()">
            <lucide-icon name="Activity" size="16"></lucide-icon>
            <span>{{ 'profile.quickActions.activity' | translate }}</span>
            <lucide-icon class="arrow" name="ChevronRight" size="16"></lucide-icon>
          </button>
          <button class="action-button danger" type="button" (click)="deleteAccount()">
            <lucide-icon name="Trash2" size="16"></lucide-icon>
            <span>{{ 'profile.quickActions.delete' | translate }}</span>
            <lucide-icon class="arrow" name="ChevronRight" size="16"></lucide-icon>
          </button>
        </section>

        <section class="preferences-card">
          <h3 class="card-title">{{ 'profile.preferences.title' | translate }}</h3>
          <div class="preference-row">
            <div>
              <div class="preference-title">{{ 'profile.preferences.transactional.title' | translate }}</div>
              <div class="preference-description">
                {{ 'profile.preferences.transactional.description' | translate }}
              </div>
            </div>
            <label class="toggle-switch">
              <input
                type="checkbox"
                [(ngModel)]="preferences.emailNotifications"
                (change)="savePreferences()"
              />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="preference-row">
            <div>
              <div class="preference-title">{{ 'profile.preferences.push.title' | translate }}</div>
              <div class="preference-description">
                {{ 'profile.preferences.push.description' | translate }}
              </div>
            </div>
            <label class="toggle-switch">
              <input
                type="checkbox"
                [(ngModel)]="preferences.pushNotifications"
                (change)="savePreferences()"
              />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="preference-row">
            <div>
              <div class="preference-title">{{ 'profile.preferences.marketing.title' | translate }}</div>
              <div class="preference-description">
                {{ 'profile.preferences.marketing.description' | translate }}
              </div>
            </div>
            <label class="toggle-switch">
              <input
                type="checkbox"
                [(ngModel)]="preferences.marketingEmails"
                (change)="savePreferences()"
              />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </section>
      </aside>

      <main class="profile-main">
        <section class="info-card">
          <div class="card-header">
            <h3 class="card-title">{{ 'profile.personal.title' | translate }}</h3>
            <button
              class="btn btn-secondary"
              type="button"
              *ngIf="!editingPersonal"
              (click)="toggleEditPersonal()"
            >
              <lucide-icon name="Edit" size="16"></lucide-icon>
              {{ 'profile.personal.edit' | translate }}
            </button>
          </div>

          <form
            *ngIf="editingPersonal; else personalView"
            [formGroup]="personalForm"
            class="form-grid"
          >
            <label class="form-group">
              <span>{{ 'profile.personal.firstName' | translate }}</span>
              <input type="text" formControlName="firstName" />
            </label>
            <label class="form-group">
              <span>{{ 'profile.personal.lastName' | translate }}</span>
              <input type="text" formControlName="lastName" />
            </label>
            <label class="form-group full-width">
              <span>{{ 'profile.personal.email' | translate }}</span>
              <input type="email" formControlName="email" [disabled]="true" />
            </label>
            <label class="form-group">
              <span>{{ 'profile.personal.phone' | translate }}</span>
              <input type="tel" formControlName="phone" />
            </label>
            <label class="form-group">
              <span>{{ 'profile.personal.username' | translate }}</span>
              <input type="text" formControlName="username" />
            </label>
            <div class="form-actions full-width">
              <button
                class="btn btn-secondary"
                type="button"
                (click)="cancelEditPersonal()"
              >
                {{ 'profile.personal.cancel' | translate }}
              </button>
              <button
                class="btn btn-primary"
                type="button"
                (click)="savePersonal()"
                [disabled]="personalForm.invalid || savingPersonal"
              >
                {{ savingPersonal ? ( 'profile.personal.saving' | translate ) : ( 'profile.personal.save' | translate ) }}
              </button>
            </div>
          </form>
          <ng-template #personalView>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">{{ 'profile.personal.fullName' | translate }}</span>
                <span class="info-value">{{ currentUser.name }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'profile.personal.email' | translate }}</span>
                <span class="info-value">{{ currentUser.email }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'profile.personal.phone' | translate }}</span>
                <span class="info-value">
                  {{ currentUser.phone || ('profile.personal.unset' | translate) }}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'profile.personal.username' | translate }}</span>
                <span class="info-value">{{ currentUser.username }}</span>
              </div>
            </div>
          </ng-template>
        </section>

        <section class="info-card">
          <div class="card-header">
            <h3 class="card-title">{{ 'profile.roles.title' | translate }}</h3>
            <span class="badge badge-info">{{ 'profile.roles.badge' | translate }}</span>
          </div>
          <div class="roles-container">
            <span class="role-chip" *ngFor="let role of currentUser.roles">
              <lucide-icon name="Shield" size="16"></lucide-icon>
              {{ getRoleLabel(role) }}
            </span>
          </div>
          <div class="help-box">
            <lucide-icon name="Info" size="16"></lucide-icon>
            <p>
              {{ 'profile.roles.helper' | translate }}
            </p>
            <a *ngIf="currentUser.roles.includes('admin')" routerLink="/admin" class="help-link">
              {{ 'profile.roles.link' | translate }}
            </a>
          </div>
        </section>

        <section class="info-card security-card">
          <div class="card-header">
            <h3 class="card-title">{{ 'profile.security.title' | translate }}</h3>
          </div>
          <div class="security-item">
            <div class="security-icon">
              <lucide-icon name="Lock" size="18"></lucide-icon>
            </div>
            <div>
              <div class="security-title">{{ 'profile.security.password' | translate }}</div>
              <div class="security-description">
                {{ 'profile.security.lastUpdate' | translate }}:
                {{
                  currentUser.passwordUpdatedAt
                    ? (currentUser.passwordUpdatedAt | date: 'dd/MM/yyyy')
                    : ('profile.security.notAvailable' | translate)
                }}
              </div>
            </div>
            <button class="btn btn-secondary-sm" (click)="changePassword()">
              {{ 'profile.security.change' | translate }}
            </button>
          </div>
          <div class="security-item">
            <div class="security-icon">
              <lucide-icon name="ShieldCheck" size="18"></lucide-icon>
            </div>
            <div>
              <div class="security-title">{{ 'profile.security.twoFactor' | translate }}</div>
              <div class="security-description">
                {{ 'profile.security.twoFactorDescription' | translate }}
              </div>
            </div>
            <button class="btn btn-secondary-sm" (click)="setup2FA()">
              {{
                currentUser.twoFactorEnabled
                  ? ('profile.security.twoFactorConfigured' | translate)
                  : ('profile.security.twoFactorConfigure' | translate)
              }}
            </button>
          </div>
          <div class="security-item">
            <div class="security-icon">
              <lucide-icon name="Monitor" size="18"></lucide-icon>
            </div>
            <div>
              <div class="security-title">{{ 'profile.security.sessions' | translate }}</div>
              <div class="security-description">
                {{ 'profile.security.sessionsDescription' | translate }}:
                {{ activeSessions }}
              </div>
            </div>
            <button class="btn btn-secondary-sm" (click)="viewSessions()">
              {{ 'profile.security.sessionsButton' | translate }}
            </button>
          </div>
        </section>
      </main>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div class="profile-loading">{{ 'profile.loading' | translate }}</div>
</ng-template>







