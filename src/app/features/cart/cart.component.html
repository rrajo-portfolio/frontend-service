<section class="cart-shell" *ngIf="items$ | async as items">
  <header class="cart-hero">
    <div>
      <p class="eyebrow">{{ 'cart.eyebrow' | translate }}</p>
      <h1>{{ 'cart.title' | translate }}</h1>
      <p>{{ 'cart.description' | translate }}</p>
    </div>
    <div class="cart-hero__meta" *ngIf="items.length">
      <div class="meta-badge">
        <span>{{ getItemCount(items) }}</span>
        <small>{{ 'cart.meta.items' | translate }}</small>
      </div>
      <div class="meta-amount">
        <span>{{ 'cart.meta.amount' | translate }}</span>
        <strong>{{ getSubtotal(items) | currency : getCurrency(items) }}</strong>
      </div>
    </div>
  </header>

  <ng-container *ngIf="items.length; else emptyCart">
    <div class="cart-layout">
      <div class="cart-items">
        <h3 class="section-title">
          {{ 'cart.items.heading' | translate }}
          <small>({{ getItemCount(items) }} {{ 'cart.items.countLabel' | translate }})</small>
        </h3>

        <mat-card class="cart-item" *ngFor="let item of items">
          <div class="item-header">
            <div>
              <p class="sku">#{{ item.productId | slice: 0 : 8 }}</p>
              <h4>{{ item.productName }}</h4>
            </div>
            <button
              mat-icon-button
              type="button"
              (click)="remove(item.productId)"
              [attr.aria-label]="'cart.remove' | translate"
            >
              <lucide-icon name="Trash2" size="18"></lucide-icon>
            </button>
          </div>

          <div class="item-grid">
            <div class="metric">
              <span>{{ 'order.detail.price' | translate }}</span>
              <strong>{{ item.price | currency : (item.currency || defaultCurrency) }}</strong>
            </div>

            <div class="metric quantity">
              <span>{{ 'cart.quantity' | translate }}</span>
              <div
                class="quantity-control"
                role="group"
                [attr.aria-label]="'cart.quantity.aria.group' | translate"
              >
                <button
                  type="button"
                  class="quantity-btn"
                  (click)="stepQuantity(item.productId, -1, item.quantity)"
                  [attr.aria-label]="'cart.quantity.aria.decrease' | translate"
                >
                  <lucide-icon name="Minus" size="14"></lucide-icon>
                </button>
                <input
                  type="number"
                  [value]="item.quantity"
                  min="1"
                  (input)="updateQuantity(item.productId, $any($event.target).value)"
                />
                <button
                  type="button"
                  class="quantity-btn"
                  (click)="stepQuantity(item.productId, 1, item.quantity)"
                  [attr.aria-label]="'cart.quantity.aria.increase' | translate"
                >
                  <lucide-icon name="Plus" size="14"></lucide-icon>
                </button>
              </div>
            </div>

            <div class="metric total">
              <span>{{ 'cart.lineTotal' | translate }}</span>
              <strong>
                {{ (item.price * item.quantity) | currency : (item.currency || defaultCurrency) }}
              </strong>
            </div>
          </div>
        </mat-card>
      </div>

      <aside class="cart-summary">
        <mat-card class="summary-card">
          <div class="summary-header">
            <div>
              <p class="eyebrow">{{ 'cart.summary.title' | translate }}</p>
              <h3>{{ getGrandTotal(items) | currency : getCurrency(items) }}</h3>
            </div>
            <button
              mat-raised-button
              color="primary"
              type="button"
              [disabled]="isSubmitting"
              (click)="checkout(items)"
            >
              <lucide-icon name="CreditCard" size="18"></lucide-icon>
              {{ 'cart.payment' | translate }}
            </button>
          </div>

          <div class="summary-lines">
            <div class="line">
              <span>{{ 'cart.summary.subtotal' | translate }}</span>
              <strong>{{ getSubtotal(items) | currency : getCurrency(items) }}</strong>
            </div>
            <div class="line">
              <span>{{ 'cart.summary.taxes' | translate }}</span>
              <strong>{{ getTaxes(items) | currency : getCurrency(items) }}</strong>
            </div>
            <div class="line total">
              <span>{{ 'cart.summary.total' | translate }}</span>
              <strong>{{ getGrandTotal(items) | currency : getCurrency(items) }}</strong>
            </div>
          </div>
          <p class="summary-disclaimer">
            {{ 'cart.summary.disclaimer' | translate }}
          </p>

          <div class="customer-card" *ngIf="user">
            <div>
              <p class="customer-title">{{ 'cart.customer.title' | translate }}</p>
              <strong>{{ user.name }}</strong>
              <span>{{ 'cart.customer.email' | translate }}: {{ user.email }}</span>
              <span>{{ 'cart.customer.role' | translate }}: {{ user.roles.join(', ') }}</span>
            </div>
            <button type="button" class="link-button" (click)="goToProfile()">
              {{ 'cart.customer.manage' | translate }}
            </button>
          </div>
        </mat-card>
      </aside>
    </div>
  </ng-container>

  <ng-template #emptyCart>
    <div class="empty-cart">
      <lucide-icon name="ShoppingCart" size="48"></lucide-icon>
      <p>{{ 'cart.empty' | translate }}</p>
      <a class="btn btn-primary" routerLink="/catalog">
        <lucide-icon name="ArrowRight" size="16"></lucide-icon>
        {{ 'cart.goToCatalog' | translate }}
      </a>
    </div>
  </ng-template>
</section>
